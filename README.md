sql_scripts
===========

This is a set of sql scripts to create the default CRUD stored procedures for a given table. 
Also I added some scripts to generate C# code based on the CRUD procedures. 

These scripts are usefull for jobs like mine  where it is forbiden to use dynamic sql queries, which makes the use of tools like 
NHybernate or Entity Framework troblesome. 

I know, I know, time to find a new job, but I like it here for now.


But at least the scripts are there in case someone needs them.

So, let's do some examples.

exec dbo.cgen_usp_GENERATE_CRUD 'DB1', 'CUSTOMER_CONTACT'

This will generate the following output  (See the Messages tab in Sql Studio)

USE [DB1]
IF EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].usp_CREATE_CUSTOMER_CONTACT'))
DROP PROC [dbo].usp_CREATE_CUSTOMER_CONTACT
GO
/******************************************************************************
Author: US\mmendes
Date: 2014-04-29
Description: Create  Record in table CUSTOMER_CONTACT (AutoGenerated Script)
*****************************************************************************/
CREATE PROCEDURE [dbo].usp_CREATE_CUSTOMER_CONTACT
      @CUST_NUMBER varchar(10) = NULL,
      @SALES_ORGANIZATION varchar(4) = NULL,
      @LOGIN_ID varchar(6) = NULL,
      @ACTION_TYPE char(1),
      @SUBMITTED_AT datetime  = NULL,
      @PENDING_PROCESSES varchar(5000) = NULL
AS
INSERT INTO CUSTOMER_CONTACT(
      CUST_NUMBER,
      SALES_ORGANIZATION,
      LOGIN_ID,
      ACTION_TYPE,
      SUBMITTED_AT,
      PENDING_PROCESSES)
VALUES (
      @CUST_NUMBER,
      @SALES_ORGANIZATION,
      @LOGIN_ID,
      @ACTION_TYPE,
      @SUBMITTED_AT,
      @PENDING_PROCESSES)
GO

 GRANT EXECUTE ON [dbo].usp_CREATE_CUSTOMER_CONTACT TO ADO_CLIENTS AS [dbo] 
 GO
IF EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].usp_GET_CUSTOMER_CONTACT'))
DROP PROC [dbo].usp_GET_CUSTOMER_CONTACT
GO
/******************************************************************************
Author: US\mmendes
Date: 2014-04-29
Description: Update CUSTOMER_CONTACT (AutoGenerated Script)
*****************************************************************************/
CREATE PROCEDURE [dbo].usp_GET_CUSTOMER_CONTACT
      @ID bigint 
 AS
SELECT
      ID,
      CUST_NUMBER,
      SALES_ORGANIZATION,
      LOGIN_ID,
      ACTION_TYPE,
      SUBMITTED_AT,
      PENDING_PROCESSES
FROM CUSTOMER_CONTACT
WHERE 
       ID = @ID
GO
GRANT EXECUTE ON [dbo].usp_GET_CUSTOMER_CONTACT TO  [ADO_CLIENTS] AS [dbo]
IF @@SERVERNAME = 'DEBUG_SERVER'
   GRANT EXECUTE ON [dbo].usp_GET_CUSTOMER_CONTACT TO  [PROGRAMMERS] AS [dbo]
GO
IF EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].usp_UPDATE_CUSTOMER_CONTACT'))
DROP PROC [dbo].usp_UPDATE_CUSTOMER_CONTACT
GO
/******************************************************************************
Author: US\mmendes
Date: 2014-04-29
Description: Update CUSTOMER_CONTACT (AutoGenerated Script)
*****************************************************************************/
CREATE PROCEDURE [dbo].usp_UPDATE_CUSTOMER_CONTACT
       @ID bigint ,
       @CUST_NUMBER varchar(10) = NULL,
       @SALES_ORGANIZATION varchar(4) = NULL,
       @LOGIN_ID varchar(6) = NULL,
       @ACTION_TYPE char(1),
       @SUBMITTED_AT datetime  = NULL,
       @PENDING_PROCESSES varchar(5000) = NULL
AS
UPDATE CUSTOMER_CONTACT
SET
       CUST_NUMBER = @CUST_NUMBER,
       SALES_ORGANIZATION = @SALES_ORGANIZATION,
       LOGIN_ID = @LOGIN_ID,
       ACTION_TYPE = @ACTION_TYPE,
       SUBMITTED_AT = @SUBMITTED_AT,
       PENDING_PROCESSES = @PENDING_PROCESSES
WHERE 
       ID = @ID

GO
GRANT EXECUTE ON [dbo].usp_UPDATE_CUSTOMER_CONTACT TO  [ADO_CLIENTS] AS [dbo]
IF @@SERVERNAME = 'DEBUG_SERVER'
   GRANT EXECUTE ON [dbo].usp_UPDATE_CUSTOMER_CONTACT TO  [PROGRAMMERS] AS [dbo]
GO
IF EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].usp_DELETE_CUSTOMER_CONTACT'))
DROP PROC [dbo].usp_DELETE_CUSTOMER_CONTACT
GO
/******************************************************************************
Author: US\mmendes
Date: 2014-04-29
Description: Delete Record in table CUSTOMER_CONTACT (AutoGenerated Script)
*****************************************************************************/
CREATE PROCEDURE [dbo].usp_DELETE_CUSTOMER_CONTACT
      @ID bigint 
 AS
DELETE FROM CUSTOMER_CONTACT
WHERE

       ID=@ID
GO

 GRANT EXECUTE ON [dbo].usp_DELETE_CUSTOMER_CONTACT TO  [ADO_CLIENTS] AS [dbo]
IF @@SERVERNAME = 'DEBUG_SERVER'
   GRANT EXECUTE ON [dbo].usp_DELETE_CUSTOMER_CONTACT TO  [PROGRAMMERS] AS [dbo]
GO



To  Delete, Update or  Select a record you need some fields to uniquely identity the records.
By default the generated script uses the  Columns that are part of the Primary Key. If no primary key is 
Found, it uses any autogenerated columns,  if that do not exist if gets the first set of columns that have indices. 

The columns to be used as selectors can be set with one extra parameter. In the example above, you would do

exec dbo.cgen_usp_GENERATE_CRUD 'DB1', 'CUSTOMER_CONTACT', ‘CUST_NUMBER,SALES_ORGANIZATION,LOGIN_ID’


I Can also create stored procedures  to generate the C# code that call the  CRUD methods.
The example above will print the code for the Structure DTO,  A Get Method and an update method

[USE_SAP_PRIORITY_SMB]
exec dbo.cgen_usp_GENERATE_C#_RECORD 'DB1', 'CUSTOMER_CONTACT'
exec dbo.cgen_usp_GENERATE_C#_GET_METHOD 'DB1', 'CUSTOMER_CONTACT'
exec dbo.cgen_usp_GENERATE_C#_UPDATE_METHOD 'DB1', 'CUSTOMER_CONTACT'

The output is 

public class CustomerContactChangeEventsQueue
{
      public long Id {get; set;}
      public String CustNumber {get; set;}
      public String SalesOrganization {get; set;}
      public String TdolLoginId {get; set;}
      public char ActionType {get; set;}
      public DateTime? SubmittedAt {get; set;}
      public String PendingProcesses {get; set;}

 }

public CustomerContactChangeEventsQueue GetCustomerContactChangeEventsQueue(long Id)
{
    using (var conn = new SqlConnection(GetConnectionString()))
       {
              conn.Open();
              using (var cmd = conn.CreateCommand())
              {
                     cmd.CommandType = System.Data.CommandType.StoredProcedure;
                     cmd.CommandText = "[dbo].usp_GET_CUSTOMER_CONTACT";
                    cmd.Parameters.Add(new SqlParameter("@ID", Id));

                     using (var reader = cmd.ExecuteReader(CommandBehavior.CloseConnection))
                     {
                           var rec = new CustomerContactChangeEventsQueue();
                           if (reader.HasRows)
                           {
                                  reader.Read();
                                 rec.Id=reader.Get<long>("ID");
                                 rec.CustNumber=reader.Get<String>("CUST_NUMBER");
                                 rec.SalesOrganization=reader.Get<String>("SALES_ORGANIZATION");
                                 rec.TdolLoginId=reader.Get<String>("LOGIN_ID");
                                 rec.ActionType=reader.Get<char>("ACTION_TYPE");
                                 rec.SubmittedAt=reader.Get<DateTime?>("SUBMITTED_AT");
                                 rec.PendingProcesses=reader.Get<String>("PENDING_PROCESSES");

                           }
                           else
                           {
                                  throw new Exception("Database Inconsistency: The Record was not found in Table CUSTOMER_CONTACT"); 
                           }
                           return rec;
                     }
              }
       }
}
public void UpdateCustomerContactChangeEventsQueue(CustomerContactChangeEventsQueue record)
{
    using (var conn = new SqlConnection(GetConnectionString()))
       {
              conn.Open();
              using (var cmd = conn.CreateCommand())
              {
                     cmd.CommandType = System.Data.CommandType.StoredProcedure;
                     cmd.CommandText = "[dbo].usp_UPDATE_CUSTOMER_CONTACT";
                    cmd.Parameters.Add(new SqlParameter("@ID", record.Id));
                    cmd.Parameters.Add(new SqlParameter("@CUST_NUMBER", record.CustNumber));
                    cmd.Parameters.Add(new SqlParameter("@SALES_ORGANIZATION", record.SalesOrganization));
                    cmd.Parameters.Add(new SqlParameter("@LOGIN_ID", record.TdolLoginId));
                    cmd.Parameters.Add(new SqlParameter("@ACTION_TYPE", record.ActionType));
                    cmd.Parameters.Add(new SqlParameter("@SUBMITTED_AT", record.SubmittedAt));
                    cmd.Parameters.Add(new SqlParameter("@PENDING_PROCESSES", record.PendingProcesses));

                     cmd.ExecuteNonQuery();
              }
       }
}



